<!-- ì±—ë´‡ ì—´ê¸° ë²„íŠ¼ -->
<div id="chat-toggle"
     onclick="toggleChatbot()"
     style="position: fixed;
            bottom: 24px;
            right: 24px;
            background: #000;
            color: #fff;
            padding: 10px 16px;
            border-radius: 9999px;
            font-size: 14px;
            font-weight: bold;
            font-family: sans-serif;
            display: none;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            z-index: 10000;">
  <span style="font-size: 16px;">ğŸ’¬</span> TEo ì±—ë´‡ ì—´ê¸°
</div>

<!-- ì±—ë´‡ ì „ì²´ ì°½ -->
<div id="chat-container"
     style="position: fixed;
            bottom: 24px;
            right: 24px;
            width: 320px;
            max-height: 600px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            z-index: 9999;
            display: flex;
            flex-direction: column;">
  <div style="background: #000; color: white; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
    <span>ğŸ¤– TEo ì±—ë´‡</span>
    <button onclick="closeChatbot()" style="background: transparent; border: none; color: white; font-size: 16px; cursor: pointer;">âœ–</button>
  </div>
  <div id="chat-messages" style="flex: 1; padding: 10px; overflow-y: auto; font-size: 14px; white-space: pre-line;"></div>
  <div style="padding: 8px; border-top: 1px solid #eee;">
    <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="width: 100%; padding: 6px;" onkeydown="handleKey(event)" />
  </div>
</div>

<script>
  const messages = [
    {
      role: "system",
      content: `ë‹¹ì‹ ì€ [TEo] ì›¹ì‚¬ì´íŠ¸ì— íƒ‘ì¬ëœ ê³ ê° ì§€ì› ì±—ë´‡ì…ë‹ˆë‹¤.\n\në°©ë¬¸ìì—ê²Œ ì œê³µí•˜ëŠ” í”„ë¡œê·¸ë¨ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:\n1. ìœ íŠœë¸Œ ë™ì˜ìƒ ë‹¤ìš´ë¡œë”\n2. ëª¨ì…˜ìº¡ì³ í”„ë¡œê·¸ë¨\n3. ëª¨ì…˜ ê¸°ë°˜ ì»´í“¨í„° ì œì–´ í”„ë¡œê·¸ë¨\n\nì±—ë´‡ì€ ê³ ê°ì˜ ì§ˆë¬¸ì— ì¹œì ˆí•˜ê²Œ í•œêµ­ì–´ë¡œ ë‹µë³€í•©ë‹ˆë‹¤.`
    }
  ];

  function appendMessage(role, content) {
    const chat = document.getElementById('chat-messages');
    const msg = document.createElement('div');
    msg.style.margin = '8px 0';
    msg.innerHTML = `<b>${role === 'user' ? 'ğŸ™‹ ì‚¬ìš©ì' : 'ğŸ¤– ì±—ë´‡'}:</b> ${content}`;
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
  }

  function sendMessage() {
    const input = document.getElementById('chat-input');
    const userMsg = input.value.trim();
    if (!userMsg) return;

    appendMessage('user', userMsg);
    messages.push({ role: 'user', content: userMsg });
    input.value = '';

    fetch("/chatbot/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        messages: messages,
        topP: 0.6,
        topK: 0,
        maxTokens: 200,
        temperature: 0.5,
        repeatPenalty: 1.2,
        includeAiFilters: true,
        seed: 0
      })
    })
    .then(res => res.json())
    .then(data => {
      const reply = (data.reply || "ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤.")
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\\n/g, '\n')
        .replace(/\\r/g, '');
      appendMessage('assistant', reply);
      messages.push({ role: 'assistant', content: reply });
    })
    .catch(err => {
      appendMessage('assistant', 'âš ï¸ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      console.error(err);
    });
  }

  function handleKey(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      sendMessage();
    }
  }

  function closeChatbot() {
    document.getElementById('chat-container').style.display = 'none';
    document.getElementById('chat-toggle').style.display = 'flex';
  }

  function toggleChatbot() {
    document.getElementById('chat-container').style.display = 'flex';
    document.getElementById('chat-toggle').style.display = 'none';
  }
</script>
